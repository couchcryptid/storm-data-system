services:
  # --- Infrastructure ---

  kafka:
    image: apache/kafka:3.7.0
    container_name: kafka
    env_file: .env.kafka
    ports:
      - "29092:29092"
    healthcheck:
      test: ["CMD-SHELL", "/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  postgres:
    image: postgres:16
    container_name: postgres
    env_file: .env.postgres
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U storm -d stormdata"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  kafka-init:
    image: apache/kafka:3.7.0
    container_name: kafka-init
    depends_on:
      kafka:
        condition: service_healthy
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        /opt/kafka/bin/kafka-topics.sh --bootstrap-server kafka:9092 \
          --create --if-not-exists \
          --topic raw-weather-reports \
          --partitions 1 --replication-factor 1
        /opt/kafka/bin/kafka-topics.sh --bootstrap-server kafka:9092 \
          --create --if-not-exists \
          --topic transformed-weather-data \
          --partitions 1 --replication-factor 1
        echo "Topics created successfully"
    restart: "no"

  # --- Mock NOAA Server ---

  mock-server:
    build:
      context: ./mock-server
    container_name: mock-server
    ports:
      - "8090:8080"
    healthcheck:
      test: ["CMD", "/bin/busybox", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    restart: unless-stopped

  # --- Application Services ---

  collector:
    build:
      context: ../storm-data-collector
      target: runner
    container_name: storm-data-collector
    ports:
      - "3000:3000"
    environment:
      KAFKA_BROKERS: kafka:9092
      KAFKA_CLIENT_ID: storm-data-collector
      KAFKA_TOPIC: raw-weather-reports
      REPORTS_BASE_URL: http://mock-server:8080/
      REPORT_TYPES: torn,hail,wind
      CRON_SCHEDULE: "0 0 * * *"
      LOG_LEVEL: info
    depends_on:
      kafka-init:
        condition: service_completed_successfully
      mock-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  etl:
    build:
      context: ../storm-data-etl
    container_name: storm-data-etl
    ports:
      - "8081:8080"
    environment:
      KAFKA_BROKERS: kafka:9092
      KAFKA_SOURCE_TOPIC: raw-weather-reports
      KAFKA_SINK_TOPIC: transformed-weather-data
      KAFKA_GROUP_ID: storm-data-etl
      HTTP_ADDR: ":8080"
      LOG_LEVEL: info
      LOG_FORMAT: json
      SHUTDOWN_TIMEOUT: 10s
    depends_on:
      kafka-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "/bin/busybox", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  api:
    build:
      context: ../storm-data-api
    container_name: storm-data-api
    ports:
      - "8080:8080"
    environment:
      DATABASE_URL: postgres://storm:storm@postgres:5432/stormdata?sslmode=disable
      KAFKA_BROKERS: kafka:9092
      KAFKA_TOPIC: transformed-weather-data
      KAFKA_GROUP_ID: storm-data-api
      LOG_LEVEL: info
      LOG_FORMAT: json
    depends_on:
      postgres:
        condition: service_healthy
      kafka-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "/bin/busybox", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # --- Dashboard ---

  dashboard:
    image: nginx:1-alpine
    container_name: dashboard
    ports:
      - "8000:80"
    volumes:
      - ./dashboard:/usr/share/nginx/html:ro
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:80/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    restart: unless-stopped

  # --- Monitoring Stack ---

  prometheus:
    image: prom/prometheus:v3.2.1
    container_name: prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    depends_on:
      collector:
        condition: service_healthy
      etl:
        condition: service_healthy
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "promtool", "check", "healthy"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    ports:
      - "8082:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: storm-kafka
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
    depends_on:
      kafka:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

volumes:
  pgdata:
  prometheus-data:
