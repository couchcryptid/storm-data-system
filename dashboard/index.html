<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Storm Data Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root {
      --bg: #0f1117;
      --surface: #1a1d27;
      --border: #2a2d3a;
      --text: #e1e4ed;
      --text-dim: #8b8fa3;
      --hail: #38bdf8;
      --tornado: #f87171;
      --wind: #a78bfa;
      --accent: #60a5fa;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding-bottom: 44px;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
    }
    header h1 {
      font-size: 20px;
      font-weight: 600;
    }
    header h1 span { color: var(--accent); }
    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .status {
      font-size: 13px;
      color: var(--text-dim);
    }
    .status.ok { color: #4ade80; }
    .status.err { color: var(--tornado); }

    /* Data freshness badge */
    .freshness {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface);
    }
    .freshness-label { color: var(--text-dim); }
    .freshness-value { font-weight: 600; }
    .freshness-ok .freshness-value { color: #4ade80; }
    .freshness-warn .freshness-value { color: #fde047; }
    .freshness-stale .freshness-value { color: #fb923c; }
    .freshness-err .freshness-value { color: var(--tornado); }

    /* System toolbar */
    .system-toolbar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 8px 24px;
      border-bottom: 1px solid var(--border);
    }
    .tool-link {
      padding: 5px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      color: var(--text-dim);
      text-decoration: none;
      font-size: 12px;
      transition: border-color 0.2s, color 0.2s;
    }
    .tool-link:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      padding: 16px 24px;
    }
    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
    }
    .stat-card .label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-dim);
      margin-bottom: 4px;
    }
    .stat-card .value {
      font-size: 28px;
      font-weight: 700;
    }
    .stat-card .sub {
      font-size: 12px;
      color: var(--text-dim);
      margin-top: 2px;
    }
    .stat-card.hail .value { color: var(--hail); }
    .stat-card.tornado .value { color: var(--tornado); }
    .stat-card.wind .value { color: var(--wind); }

    /* Activity timeline */
    .timeline-section {
      margin: 0 24px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
    }
    .timeline-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
    }
    .timeline {
      display: flex;
      align-items: flex-end;
      gap: 3px;
      height: 140px;
      overflow-x: auto;
    }
    .tl-bar {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      min-width: 28px;
    }
    .tl-count {
      font-size: 10px;
      font-weight: 600;
      color: var(--text-dim);
      margin-bottom: 2px;
    }
    .tl-stacks {
      display: flex;
      flex-direction: column-reverse;
      width: 100%;
      gap: 1px;
    }
    .tl-seg {
      width: 100%;
      border-radius: 2px;
      min-height: 0;
    }
    .tl-seg.hail { background: var(--hail); }
    .tl-seg.tornado { background: var(--tornado); }
    .tl-seg.wind { background: var(--wind); }
    .tl-label {
      font-size: 10px;
      color: var(--text-dim);
      margin-top: 4px;
      white-space: nowrap;
    }
    .tl-legend {
      display: flex;
      gap: 16px;
      margin-top: 10px;
      font-size: 11px;
      color: var(--text-dim);
    }
    .tl-legend-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 2px;
      margin-right: 4px;
      vertical-align: middle;
    }

    .main {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      padding: 0 24px 24px;
    }
    .panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }
    .panel-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
      font-weight: 600;
    }
    #map { height: 480px; }
    .table-wrap {
      max-height: 480px;
      overflow-y: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    thead th {
      position: sticky;
      top: 0;
      background: var(--surface);
      padding: 8px 12px;
      text-align: left;
      font-weight: 600;
      color: var(--text-dim);
      border-bottom: 1px solid var(--border);
    }
    tbody td {
      padding: 6px 12px;
      border-bottom: 1px solid var(--border);
    }
    tbody tr:hover { background: rgba(255,255,255,0.03); }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .badge.hail { background: rgba(56,189,248,0.15); color: var(--hail); }
    .badge.tornado { background: rgba(248,113,113,0.15); color: var(--tornado); }
    .badge.wind { background: rgba(167,139,250,0.15); color: var(--wind); }
    .severity-minor { color: #86efac; }
    .severity-moderate { color: #fde047; }
    .severity-severe { color: #fb923c; }
    .severity-extreme { color: #f87171; }
    .controls {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
    }
    .controls label { font-size: 12px; color: var(--text-dim); }
    .controls select, .controls input {
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 13px;
    }
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 200px;
      color: var(--text-dim);
    }

    /* Query panel */
    .query-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      transition: height 0.25s ease;
      height: 44px;
      overflow: hidden;
    }
    .query-panel.expanded { height: 400px; }
    .query-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      min-height: 44px;
      cursor: pointer;
    }
    .query-bar-left {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }
    .query-bar-left .arrow {
      font-size: 10px;
      color: var(--text-dim);
      transition: transform 0.25s;
    }
    .query-panel.expanded .query-bar-left .arrow { transform: rotate(180deg); }
    .query-bar-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .query-bar-right label {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 12px;
      color: var(--text-dim);
      cursor: pointer;
    }
    .query-run-btn {
      padding: 4px 12px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }
    .query-run-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .query-run-btn:not(:disabled):hover { background: #4a90d9; }
    .query-time { font-size: 11px; color: var(--text-dim); }
    .query-body {
      display: flex;
      gap: 12px;
      padding: 0 24px 16px;
      flex: 1;
      overflow: hidden;
    }
    .query-textarea {
      flex: 1;
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      font-family: 'SF Mono', Monaco, 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.5;
      resize: none;
      tab-size: 2;
    }
    .query-result {
      flex: 1;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      font-family: 'SF Mono', Monaco, 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.5;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
      color: var(--text-dim);
    }

    @media (max-width: 900px) {
      .stats { grid-template-columns: repeat(2, 1fr); }
      .main { grid-template-columns: 1fr; }
      .query-body { flex-direction: column; }
    }
  </style>
</head>
<body>
  <header>
    <h1><span>Storm Data</span> Dashboard</h1>
    <div class="header-right">
      <div id="freshness" class="freshness" style="display:none">
        <span class="freshness-label">Data lag:</span>
        <span id="freshness-value" class="freshness-value">--</span>
      </div>
      <div id="status" class="status">Connecting...</div>
    </div>
  </header>

  <div class="system-toolbar">
    <a href="http://localhost:8080" target="_blank" rel="noopener noreferrer" class="tool-link">GraphQL Playground</a>
    <a href="http://localhost:9090" target="_blank" rel="noopener noreferrer" class="tool-link">Prometheus</a>
    <a href="http://localhost:8082" target="_blank" rel="noopener noreferrer" class="tool-link">Kafka UI</a>
  </div>

  <div class="stats">
    <div class="stat-card">
      <div class="label">Total Reports</div>
      <div class="value" id="total">--</div>
      <div class="sub" id="date-range"></div>
    </div>
    <div class="stat-card hail">
      <div class="label">Hail</div>
      <div class="value" id="hail-count">--</div>
      <div class="sub" id="hail-max"></div>
    </div>
    <div class="stat-card tornado">
      <div class="label">Tornado</div>
      <div class="value" id="tornado-count">--</div>
      <div class="sub" id="tornado-max"></div>
    </div>
    <div class="stat-card wind">
      <div class="label">Wind</div>
      <div class="value" id="wind-count">--</div>
      <div class="sub" id="wind-max"></div>
    </div>
  </div>

  <div class="timeline-section">
    <div class="timeline-title">Activity by Hour (UTC)</div>
    <div id="timeline" class="timeline"></div>
    <div class="tl-legend">
      <span><span class="tl-legend-dot" style="background:var(--hail)"></span>Hail</span>
      <span><span class="tl-legend-dot" style="background:var(--tornado)"></span>Tornado</span>
      <span><span class="tl-legend-dot" style="background:var(--wind)"></span>Wind</span>
    </div>
  </div>

  <div class="main">
    <div class="panel">
      <div class="panel-header" style="display:flex;align-items:center;justify-content:space-between">
        Event Map
        <label style="font-size:12px;color:var(--text-dim);font-weight:normal;display:flex;align-items:center;gap:4px">
          Color:
          <select id="map-color-mode" style="background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:2px 6px;font-size:12px">
            <option value="type">By Type</option>
            <option value="severity">By Severity</option>
          </select>
        </label>
      </div>
      <div id="map"></div>
    </div>
    <div class="panel">
      <div class="panel-header">Reports</div>
      <div class="controls">
        <label>Type:
          <select id="filter-type">
            <option value="">All</option>
            <option value="hail">Hail</option>
            <option value="tornado">Tornado</option>
            <option value="wind">Wind</option>
          </select>
        </label>
        <label>State:
          <select id="filter-state"><option value="">All</option></select>
        </label>
        <label>Severity:
          <select id="filter-severity">
            <option value="">All</option>
            <option value="minor">Minor</option>
            <option value="moderate">Moderate</option>
            <option value="severe">Severe</option>
            <option value="extreme">Extreme</option>
          </select>
        </label>
        <label>County:
          <select id="filter-county" disabled><option value="">All</option></select>
        </label>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Type</th>
              <th>Location</th>
              <th>State</th>
              <th>Magnitude</th>
              <th>Severity</th>
              <th>Time (UTC)</th>
            </tr>
          </thead>
          <tbody id="report-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Query panel (fixed bottom drawer) -->
  <div id="query-panel" class="query-panel">
    <div class="query-bar" id="query-bar">
      <div class="query-bar-left">
        <span class="arrow">&#9650;</span>
        GraphQL Query
      </div>
      <div class="query-bar-right">
        <label><input type="checkbox" id="query-editable"> Edit</label>
        <button id="query-run" class="query-run-btn" disabled>Run</button>
        <span id="query-time" class="query-time"></span>
      </div>
    </div>
    <div class="query-body">
      <textarea id="query-text" class="query-textarea" readonly spellcheck="false"></textarea>
      <pre id="query-result" class="query-result">Run a query to see results here.</pre>
    </div>
  </div>

<script type="module">
const loc = globalThis.location;
const API_URL = loc.hostname === 'localhost'
  ? 'http://localhost:8080/query'
  : `${loc.protocol}//${loc.hostname}:8080/query`;

const COLORS = { hail: '#38bdf8', tornado: '#f87171', wind: '#a78bfa' };
const SEVERITY_COLORS = { minor: '#86efac', moderate: '#fde047', severe: '#fb923c', extreme: '#f87171' };

function esc(text) {
  const d = document.createElement('div');
  d.textContent = text;
  return d.innerHTML;
}

const map = L.map('map', { zoomControl: true }).setView([39.5, -98.5], 5);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
  subdomains: 'abcd',
  maxZoom: 19
}).addTo(map);

let allReports = [];
let markers = L.layerGroup().addTo(map);

// ── GraphQL client ──────────────────────────────────────────

async function gql(query) {
  const res = await fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ query })
  });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const json = await res.json();
  if (json.errors) throw new Error(json.errors.map(e => e.message).join(', '));
  return json.data;
}

// ── Formatters ──────────────────────────────────────────────

function fmtMag(r) {
  const m = r.measurement;
  if (!m.magnitude) return '--';
  if (m.unit === 'in') return `${m.magnitude}"`;
  if (m.unit === 'mph') return `${m.magnitude} mph`;
  if (m.unit === 'f_scale') return `EF${m.magnitude}`;
  return `${m.magnitude} ${m.unit}`;
}

function fmtTime(dt) {
  if (!dt) return '';
  const d = new Date(dt);
  return d.toISOString().slice(0, 16).replace('T', ' ');
}

function fmtMaxMag(m) {
  if (!m) return '';
  if (m.unit === 'in') return `max ${m.magnitude}"`;
  if (m.unit === 'mph') return `max ${m.magnitude} mph`;
  if (m.unit === 'f_scale') return `max EF${m.magnitude}`;
  return `max ${m.magnitude}`;
}

// ── Stats cards ─────────────────────────────────────────────

function renderStats(agg) {
  const byType = {};
  for (const g of agg.byEventType) byType[g.eventType] = g;

  document.getElementById('total').textContent = agg.totalCount;
  for (const type of ['hail', 'tornado', 'wind']) {
    const g = byType[type];
    document.getElementById(`${type}-count`).textContent = g ? g.count : 0;
    document.getElementById(`${type}-max`).textContent = g ? fmtMaxMag(g.maxMeasurement) : '';
  }
}

// ── Data freshness ──────────────────────────────────────────

function renderFreshness(meta) {
  const el = document.getElementById('freshness');
  const val = document.getElementById('freshness-value');
  if (!meta) return;
  el.style.display = '';

  if (meta.dataLagMinutes != null) {
    const lag = meta.dataLagMinutes;
    val.textContent = lag < 60 ? `${lag}m` : `${Math.floor(lag / 60)}h ${lag % 60}m`;
    let level = 'freshness-err';
    if (lag < 5) level = 'freshness-ok';
    else if (lag < 30) level = 'freshness-warn';
    else if (lag < 60) level = 'freshness-stale';
    el.className = `freshness ${level}`;
  } else if (meta.lastUpdated) {
    val.textContent = fmtTime(meta.lastUpdated) + ' UTC';
    el.className = 'freshness freshness-warn';
  } else {
    val.textContent = 'No data';
    el.className = 'freshness freshness-err';
  }
}

// ── Activity timeline ───────────────────────────────────────

function renderTimeline(reports) {
  const buckets = {};
  for (const r of reports) {
    // Truncate eventTime to the hour
    const hour = r.eventTime.slice(0, 13) + ':00';
    if (!buckets[hour]) buckets[hour] = { hail: 0, tornado: 0, wind: 0 };
    buckets[hour][r.eventType] = (buckets[hour][r.eventType] || 0) + 1;
  }

  const sorted = Object.keys(buckets).sort();
  const el = document.getElementById('timeline');
  el.innerHTML = '';

  if (sorted.length === 0) {
    el.innerHTML = '<span style="color:var(--text-dim);font-size:13px">No activity data</span>';
    return;
  }

  const maxTotal = Math.max(...sorted.map(k => {
    const b = buckets[k];
    return b.hail + b.tornado + b.wind;
  }));
  const maxBarHeight = 100;

  for (const hour of sorted) {
    const c = buckets[hour];
    const total = c.hail + c.tornado + c.wind;
    const scale = total / maxTotal;

    const bar = document.createElement('div');
    bar.className = 'tl-bar';

    const countEl = document.createElement('div');
    countEl.className = 'tl-count';
    countEl.textContent = total;
    bar.appendChild(countEl);

    const stacks = document.createElement('div');
    stacks.className = 'tl-stacks';

    for (const type of ['hail', 'tornado', 'wind']) {
      if (c[type] > 0) {
        const seg = document.createElement('div');
        seg.className = `tl-seg ${type}`;
        seg.style.height = `${(c[type] / total) * scale * maxBarHeight}px`;
        seg.title = `${type}: ${c[type]}`;
        stacks.appendChild(seg);
      }
    }
    bar.appendChild(stacks);

    const label = document.createElement('div');
    label.className = 'tl-label';
    label.textContent = hour.slice(11, 16);
    bar.appendChild(label);

    el.appendChild(bar);
  }
}

// ── Map markers ─────────────────────────────────────────────

function createMarker(r) {
  const colorMode = document.getElementById('map-color-mode').value;
  let color, radius;

  if (colorMode === 'severity') {
    color = SEVERITY_COLORS[r.measurement.severity] || '#666';
    const mag = r.measurement.magnitude || 0;
    if (r.eventType === 'hail') radius = Math.min(14, Math.max(4, mag * 4));
    else if (r.eventType === 'tornado') radius = Math.min(14, Math.max(4, mag * 2 + 4));
    else if (r.eventType === 'wind') radius = Math.min(14, Math.max(4, (mag - 40) / 6 + 4));
    else radius = 5;
  } else {
    color = COLORS[r.eventType] || '#fff';
    const sev = r.measurement.severity;
    radius = 5;
    if (sev === 'moderate') radius = 7;
    if (sev === 'severe') radius = 9;
    if (sev === 'extreme') radius = 12;
  }

  return L.circleMarker([r.geo.lat, r.geo.lon], {
    radius,
    fillColor: color,
    color: color,
    weight: 1,
    opacity: 0.8,
    fillOpacity: 0.5
  }).bindPopup(`
    <div style="font-size:13px;min-width:180px">
      <strong>${esc(r.eventType.toUpperCase())}</strong> &mdash; ${fmtMag(r)}<br>
      <span style="color:#888">${esc(r.location.name || r.location.raw)}, ${esc(r.location.state)}</span><br>
      <span style="color:#888">${esc(r.location.county)} County</span><br>
      <span style="color:#888">${fmtTime(r.eventTime)}</span><br>
      ${r.comments ? `<em style="color:#aaa;font-size:12px">${esc(r.comments)}</em>` : ''}
    </div>
  `);
}

// ── Filters ─────────────────────────────────────────────────

function applyFilters() {
  const typeF = document.getElementById('filter-type').value;
  const stateF = document.getElementById('filter-state').value;
  const sevF = document.getElementById('filter-severity').value;
  const countyF = document.getElementById('filter-county').value;

  markers.clearLayers();
  const tbody = document.getElementById('report-body');
  tbody.innerHTML = '';

  const filtered = allReports.filter(r => {
    if (typeF && r.eventType !== typeF) return false;
    if (stateF && r.location.state !== stateF) return false;
    if (sevF && r.measurement.severity !== sevF) return false;
    if (countyF && r.location.county !== countyF) return false;
    return true;
  });

  for (const r of filtered) {
    markers.addLayer(createMarker(r));
    const sev = r.measurement.severity || '';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span class="badge ${esc(r.eventType)}">${esc(r.eventType)}</span></td>
      <td>${esc(r.location.name || r.location.raw)}</td>
      <td>${esc(r.location.state)}</td>
      <td>${fmtMag(r)}</td>
      <td><span class="severity-${esc(sev)}">${esc(sev) || '--'}</span></td>
      <td>${fmtTime(r.eventTime)}</td>
    `;
    tbody.appendChild(tr);
  }

  renderTimeline(filtered);
}

function populateStateFilter(reports) {
  const states = [...new Set(reports.map(r => r.location.state))].sort();
  const sel = document.getElementById('filter-state');
  for (const s of states) {
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    sel.appendChild(opt);
  }
}

function populateCountyFilter(reports, state) {
  const sel = document.getElementById('filter-county');
  sel.innerHTML = '<option value="">All</option>';
  if (!state) {
    sel.disabled = true;
    return;
  }
  sel.disabled = false;
  const counties = [...new Set(
    reports.filter(r => r.location.state === state).map(r => r.location.county)
  )].filter(Boolean).sort();
  for (const c of counties) {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    sel.appendChild(opt);
  }
}

// ── Query panel ─────────────────────────────────────────────

function setQueryText(query) {
  document.getElementById('query-text').value = query;
}

document.getElementById('query-bar').addEventListener('click', (e) => {
  if (e.target.closest('.query-bar-right')) return;
  document.getElementById('query-panel').classList.toggle('expanded');
});

document.getElementById('query-editable').addEventListener('change', (e) => {
  document.getElementById('query-text').readOnly = !e.target.checked;
  document.getElementById('query-run').disabled = !e.target.checked;
});

document.getElementById('query-run').addEventListener('click', async () => {
  const query = document.getElementById('query-text').value;
  const resultEl = document.getElementById('query-result');
  const timeEl = document.getElementById('query-time');
  resultEl.textContent = 'Running...';
  timeEl.textContent = '';

  const start = performance.now();
  try {
    const data = await gql(query);
    const elapsed = Math.round(performance.now() - start);
    timeEl.textContent = `${elapsed}ms`;
    resultEl.textContent = JSON.stringify(data, null, 2);
  } catch (err) {
    const elapsed = Math.round(performance.now() - start);
    timeEl.textContent = `${elapsed}ms`;
    resultEl.textContent = `Error: ${err.message}`;
  }
});

// ── Data fetch ──────────────────────────────────────────────

const REPORT_QUERY = `{
  stormReports(filter: {
    timeRange: { from: "2020-01-01T00:00:00Z", to: "2030-01-01T00:00:00Z" }
    sortBy: EVENT_TIME
    sortOrder: DESC
    limit: 20
    offset: __OFFSET__
  }) {
    totalCount hasMore
    reports {
      id eventType
      geo { lat lon }
      measurement { magnitude unit severity }
      eventTime
      location { raw name state county direction distance }
      comments
      sourceOffice
    }
    aggregations {
      totalCount
      byEventType { eventType count maxMeasurement { magnitude unit } }
      byState { state count }
    }
    meta { lastUpdated dataLagMinutes }
  }
}`;

async function fetchAllReports() {
  let all = [];
  let offset = 0;
  const limit = 20;
  let hasMore = true;
  let meta = null;

  while (hasMore) {
    const query = REPORT_QUERY.replace('__OFFSET__', offset);
    if (offset === 0) setQueryText(query);
    const data = await gql(query);
    const sr = data.stormReports;
    all = all.concat(sr.reports);
    hasMore = sr.hasMore;
    offset += limit;

    if (!meta) {
      renderStats(sr.aggregations);
      meta = sr.meta;
    }
  }
  return { reports: all, meta };
}

// ── Init ────────────────────────────────────────────────────

async function init() {
  const statusEl = document.getElementById('status');
  try {
    statusEl.textContent = 'Loading data...';
    const { reports, meta } = await fetchAllReports();
    allReports = reports;

    renderFreshness(meta);
    populateStateFilter(allReports);
    applyFilters();

    if (allReports.length > 0) {
      const bounds = L.latLngBounds(allReports.map(r => [r.geo.lat, r.geo.lon]));
      map.fitBounds(bounds, { padding: [30, 30] });
    }

    statusEl.textContent = `${allReports.length} reports loaded`;
    statusEl.className = 'status ok';

    const dateRange = document.getElementById('date-range');
    if (allReports.length > 0) {
      const times = allReports.map(r => new Date(r.eventTime)).sort((a, b) => a - b);
      dateRange.textContent = `${times[0].toISOString().slice(0, 10)} — ${times[times.length - 1].toISOString().slice(0, 10)}`;
    }
  } catch (err) {
    statusEl.textContent = `Error: ${err.message}`;
    statusEl.className = 'status err';
    console.error(err);
  }
}

document.getElementById('filter-type').addEventListener('change', applyFilters);
document.getElementById('filter-state').addEventListener('change', () => {
  populateCountyFilter(allReports, document.getElementById('filter-state').value);
  applyFilters();
});
document.getElementById('filter-severity').addEventListener('change', applyFilters);
document.getElementById('filter-county').addEventListener('change', applyFilters);
document.getElementById('map-color-mode').addEventListener('change', applyFilters);

await init();
</script>
</body>
</html>
